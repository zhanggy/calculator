let politics_obj={};var _input_list=[{name:"装机功率",input:{id:"A",value:2500},unit:"kWh"},{name:"装机容量",input:{id:"B",value:5e3},unit:"kWh"},{name:"单位装机成本",input:{id:"C",value:1.75},unit:"元/Wh"},{name:"峰时电价",input:{id:"D",value:0},unit:"元/kWh"},{name:"平时电价",input:{id:"E",value:0},unit:"元/kWh"},{name:"谷时电价",input:{id:"F",value:0},unit:"元/kWh"},{name:"电池循环寿命",input:{id:"G",value:5e3},unit:"次",remark:"到额定容量80%"},{name:"放电深度",input:{id:"H",value:95,min:0,max:100},unit:"%"},{name:"系统效率",input:{id:"I",value:90,min:1,max:100},unit:"%"},{name:"每天充放电循环次数",input:{id:"J",value:2,min:1,max:2},unit:"次"},{name:"每年运行天数",input:{id:"K",value:350,min:1,max:366},unit:"天"},{name:"系统寿命",input:{id:"L",value:15,min:5,max:25},unit:"年"},{name:"每年运维成本",input:{id:"M",value:.005,min:0,max:100,step:.001},unit:"元/Wh"},{name:"贷款比例",input:{id:"N",value:0,min:0,max:100},unit:"%"},{name:"贷款利率",input:{id:"O",value:5.4,min:0,max:25},unit:"%"},{name:"贷款年限",input:{id:"P",value:5,min:0},unit:"年"},{name:"度电补贴",input:{id:"Q",value:0,step:.1},unit:"元/kWh"},{name:"补贴年限",input:{id:"R",value:0,min:0},unit:"年"},{name:"保险费用",input:{id:"S",value:0,min:0},unit:"万元"},{name:"残值",input:{id:"T",value:5,min:0,max:100},unit:"%"}],_result_list=[{name:"初始投资成本",id:"Z11",unit:"万元"},{name:"首年电量收益",id:"Z12",unit:"万元"},{name:"生命周期电量总收益",id:"Z13",unit:"万元"},{name:"补贴总收益",id:"Z14",unit:"万元"},{name:"生命周期总净收益",id:"Z15",unit:"万元"},{name:"静态投资回收期",id:"Z16",unit:"年"},{name:"静态收益率IRR",id:"Z17",unit:"%"},{name:"资本金收益率",id:"Z18",unit:"%"},{name:"度电成本",id:"Z19",unit:"元/KWh"}];function loan_interest_benjin(t,n,e){let i=12*n,a=e/100/12,u=t/i,l=new Array(i).fill(0),p=new Array(n).fill(0);for(let n=0;n<i;++n)l[n]=(t-u*n)*a,p[parseInt(n/12)]+=l[n];return p}function loan_interest_benxi(t,n,e){let i=12*n,a=e/100/12,u=new Array(i).fill(0),l=new Array(n).fill(0);for(let n=0;n<i;++n){let e=t*a*(Math.pow(1+a,i)-Math.pow(1+a,n))/(Math.pow(1+a,i)-1);u[n]=e,l[parseInt(n/12)]+=e}return l}function get_politics(t){let n=new Date,e=n.getFullYear().toString()+"-"+(n.getMonth()+1).toString();data_url=document.location.pathname+"data/politics-"+e+".json",$.ajax({url:data_url,type:"GET",dataType:"json",headers:{"Content-Type":"application/json;charset=utf-8"},contentType:"application/json; charset=utf-8",success:function(n){politics_obj=n[t]||n.default,$("input#input_D").val(politics_obj["power-price"].peak),$("input#input_E").val(politics_obj["power-price"].usual),$("input#input_F").val(politics_obj["power-price"].vally)},error:function(t){console.error("Error")}})}function CalcROI(t){for(let n=1;n<t.length;++n){let e=t[n-1],i=t[n];if(e<0&&i>=0)return n+e/(e-i)}return t.length}function buildModule(){let t={};for(let n="A".charCodeAt();n<="T".charCodeAt();++n){let e=String.fromCharCode(n);t[e]=Number($("input#input_"+e).val())}if(!t.A||!t.B||!t.C)return console.log("no value"),-1;t.Z11=t.B*t.C/10,t.Z21=t.J*t.K/t.G*.2,2==t.J?t.Z22=t.D-(t.E+t.F)/2:t.Z22=t.D-t.F;let n=t.L;if(t.R>n&&(t.R=n),t.LIXI_YEAR=new Array(n).fill(0),t.N>0&&t.O>0&&t.P>0){let e=loan_interest_benjin(t.Z11*t.N/100,t.P,t.O);for(let i=0;i<n&&i<t.P;++i)t.LIXI_YEAR[i]=e[i]}t.Z13=0,t.Z14=0,t.Z24=0,t.Z25=0,t.Z26=0,t.Z27=0,t.CAP_YEAR=new Array(n).fill(0),t.DISCHARGE_YEAR=new Array(n).fill(0),t.SUBSIDY_YEAR=new Array(n).fill(0),t.BAT_INCOME_YEAR=new Array(n).fill(0),t.DEVOPS_YEAR=new Array(n).fill(0),t.PROFIT_YEAR=new Array(n).fill(0),t.CASH_YEAR=new Array(n).fill(0);let e=-t.Z11;for(let i=0;i<n;++i){t.CAP_YEAR[i]=t.B*(1-i*t.Z21);let n=t.H/100,a=t.I/100;t.DISCHARGE_YEAR[i]=t.J*t.K*n*a*t.CAP_YEAR[i]/1e4,t.Z24+=t.DISCHARGE_YEAR[i],t.BAT_INCOME_YEAR[i]=t.Z22*t.DISCHARGE_YEAR[i],i<t.R?t.SUBSIDY_YEAR[i]=t.Q*t.DISCHARGE_YEAR[i]:t.SUBSIDY_YEAR[i]=0,t.DEVOPS_YEAR[i]=t.B*t.M/10,t.Z25+=t.DEVOPS_YEAR[i],t.Z26+=t.LIXI_YEAR[i],t.Z27+=t.S,t.Z13+=t.BAT_INCOME_YEAR[i],t.Z14+=t.SUBSIDY_YEAR[i],t.PROFIT_YEAR[i]=t.BAT_INCOME_YEAR[i]+t.SUBSIDY_YEAR[i],t.PROFIT_YEAR[i]=t.PROFIT_YEAR[i]-t.LIXI_YEAR[i]-t.DEVOPS_YEAR[i],e+=t.PROFIT_YEAR[i],t.CASH_YEAR[i]=e}t.Z12=t.BAT_INCOME_YEAR[0],t.Z15=t.Z13+t.Z14-t.Z25-t.Z26-t.Z27,t.Z16=CalcROI(t.CASH_YEAR),t.Z17=t.Z15/t.L/t.Z11*100,t.Z18=t.Z15/t.L/(100-t.N)/t.Z11*1e4,t.Z19=(t.Z11*(100-t.T)/100+t.Z25+t.Z26+t.Z27+t.Z24/t.J*(t.E+t.F))/t.Z24,console.log(t),$("span#output_Z11").text(t.Z11.toFixed(2)),$("span#output_Z12").text(t.Z12.toFixed(2)),$("span#output_Z13").text(t.Z13.toFixed(2)),$("span#output_Z14").text(t.Z14.toFixed(2)),$("span#output_Z15").text(t.Z15.toFixed(2)),$("span#output_Z16").text(t.Z16.toFixed(2)),$("span#output_Z17").text(t.Z17.toFixed(2)),$("span#output_Z18").text(t.Z18.toFixed(2)),$("span#output_Z19").text(t.Z19.toFixed(2))}function onClickCalculate(){-1!=buildModule()&&($("div#layer-input").css("display","none"),$("div#layer-output").css("display","block"))}function onClickReturn(){$("div#layer-input").css("display","block"),$("div#layer-output").css("display","none")}function init_input_table(t,n){let e=1;n.forEach((n=>{let i=$("<tr></tr>"),a=$("<td>"+e+++"</td>");i.append(a);let u=$("<td>"+n.name+"</td>");i.append(u);let l="<td><input type='number' ";for(let t in n.input)l="id"===t?l+"id='input_"+n.input[t]+"' ":"value"===t?l+"value='"+(n.input[t]||0)+"' ":l+t+"='"+n.input[t]+"' ";l+="/></td>",i.append($(l));let p=$("<td>"+n.unit+"</td>");i.append(p);let o=$("<td>"+(n.range||"&nbsp;")+"</td>");i.append(o);let r=$("<td>"+(n.remark||"&nbsp;")+"</td>");i.append(r),$("#"+t).append(i)}))}function init_result_table(t,n){let e=1;n.forEach((n=>{let i=$("<tr></tr>"),a=$("<td>"+e+++"</td>");i.append(a);let u=$("<td>"+n.name+"</td>");i.append(u);let l=$("<td><span id='output_"+n.id+"'></span></td>");i.append(l);let p=$("<td>"+n.unit+"</td>");i.append(p);let o=$("<td>"+(n.remark||"&nbsp;")+"</td>");i.append(o),$("#"+t).append(i)}))}$(document).ready((function(){init_input_table("tb_body_input",_input_list),init_result_table("tb_body_result",_result_list),get_politics("jiangsu"),$("button#btn-calc").click(onClickCalculate),$("button#btn-rtn").click(onClickReturn)}));